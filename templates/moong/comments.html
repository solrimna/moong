<div class="comment-section">
    ëŒ“ê¸€ {{ post.comments.count }}ê°œ
        <ul id="comment-list" class="comments">
            {% for comment in comments|default:post.comments.all %}
                {% if not comment.parent %}
                <li style="margin-bottom: 12px;" class="comment-item">

                    <!-- comment_list -->
               
                        <img src="{{ comment.author.profile_image.url }}"
                            alt="profile"
                            class="comment-profile"
                            style=
                                "width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 2px solid #d8aac3;
                                object-fit: cover;">

              
                        <strong class="comment-author">{{ comment.author.nick_name }}</strong>
                        <small class="comment-label">ë‹˜ì˜ ëŒ“ê¸€</small> : 
                        <span class="comment-text">
                            {% if is_a_post %}  
                                {{ comment.content|truncatechars:20 }}
                            {% else %}
                                {{ comment.content }}
                            {% endif %}
                        </span>

                    <small class="comment-meta">
                        {{ comment.display_time }}
                        {% if not is_a_post %}

                            <button type="button"
                                    class="reply-toggle"
                                    data-comment-id="{{ comment.id }}">
                                Re â†³
                            </button>
                                
                        {% endif %}                   
                    </small>
                   
               

                    <!-- comment_delete -->
                    {% if comment_form and user == comment.author %}
                        <form method="POST" 
                              action="{% url 'moong:comment_delete' comment_id=comment.id %}"
                              style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-delete">Del</button>
                        </form>
                    {% endif %}
                    
                    <!-- replies list -->
                    {% for reply in comment.replies.all %}

                        <div style="margin-left:20px; margin-top:6px;" class="reply-item">
                            <strong class="reply-arrow">â†³ 
                            <img src="{{ reply.author.profile_image.url }}"
                            alt="profile"
                            class="comment-profile reply-profile"
                            style=
                                "width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 2px solid #d8aac3;
                                object-fit: cover;">
                                
                                {{ reply.author.nick_name }}</strong>
                            <small class="comment-label">ë‹˜ì˜ ëŒ“ê¸€</small> : 
                            <span class="comment-text">
                                {% if is_a_post %}
                                    {{ reply.content|truncatechars:20 }}
                                {% else %}
                                    {{ reply.content }}
                                {% endif %}
                            </span>
                            <small class="comment-meta">{{ reply.display_time }}</small>

                            <!-- reply_delete -->
                            {% if comment_form and user == reply.author %}
                                <form method="POST" 
                                    action="{% url 'moong:comment_delete' comment_id=reply.id %}"
                                    style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-delete">Del</button>
                                </form>
                            {% endif %}

                        </div>
                    {% endfor %}

                   

                    <!-- replies add -->
                
                    {% if comment_form and not is_a_post %}
                    <div class="reply-form"
                        id="reply-form-{{ comment.id }}"
                        style="display:none; margin-left:20px; margin-top:8px;">
                        <form method="POST"
                            action="{% url 'moong:comment_add' post_id=post.id %}">
                            {% csrf_token %}
                            {{ comment_form.content }}
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <button type="submit" class="btn-submit-reply">ëŒ€ëŒ“ê¸€ ë“±ë¡</button>                
                        </form>
                    </div>  
                    {% endif %}                                 
                    
                </li>
                {% endif %}
            {% empty %}
                <li class="comment-empty">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
            {% endfor %}
        </ul>
</div>

<!-- comment add -->      

{% if comment_form %}
<div style="margin-top:16px;" class="comment-write-section">
    <form method="POST" action="{% url 'moong:comment_add' post_id=post.id %}">
        {% csrf_token %}
        {{ comment_form.content }}
        <button type="submit" class="btn-submit-comment">ëŒ“ê¸€ ë“±ë¡</button>
    </form>
</div>
{% endif %}

<!-- ğŸ”½ JS: ëŒ€ëŒ“ê¸€ í¼ í† ê¸€ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".reply-toggle").forEach(function (btn) {
        btn.addEventListener("click", function () {

            const commentId = this.dataset.commentId;
            const form = document.getElementById("reply-form-" + commentId);

            if (!form) return;

            // 1ï¸âƒ£ ë‹¤ë¥¸ ëŒ€ëŒ“ê¸€ í¼ ë‹«ê¸° (UX)
            document.querySelectorAll(".reply-form").forEach(f => {
                f.style.display = "none";
            });

            // 2ï¸âƒ£ í˜„ì¬ í¼ ì—´ê¸°
            form.style.display = "block";

            // 3ï¸âƒ£ â­ ë Œë”ë§ ì´í›„ inputì— í¬ì»¤ìŠ¤ (í•µì‹¬)
            requestAnimationFrame(() => {
                const input = form.querySelector("input[type='text']");
                if (input) {
                    input.focus({ preventScroll: true });
                    input.scrollIntoView({
                        behavior: "smooth",
                        block: "center"
                    });
                }
            });
        });
    });
});
</script>
