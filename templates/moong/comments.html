<div>
    댓글 {{ post.comments.count }}개
        <ul>
            {% for comment in comments|default:post.comments.all %}
                {% if not comment.parent %}
                <li>

                    <!-- comment_list -->

                        <img src="{{ comment.author.profile_image.url }}"
                            alt="profile"
                            class="comment-profile">


                        <strong>{{ comment.author.nick_name }}</strong>
                        <small>님의 댓글</small> :
                        <span>
                            {% if is_a_post %}
                                {{ comment.content|truncatechars:20 }}
                            {% else %}
                                {{ comment.content }}
                            {% endif %}
                        </span>

                    <small>
                        {{ comment.display_time }}
                        {% if not is_a_post %}

                            <button type="button"
                                    class="reply-toggle"
                                    data-comment-id="{{ comment.id }}">
                                Re ↳
                            </button>

                        {% endif %}
                    </small>


                    <!-- comment_delete -->
                    {% if comment_form and user == comment.author %}
                        <form method="POST"
                              action="{% url 'moong:comment_delete' comment_id=comment.id %}"
                              style="display:inline;">
                            {% csrf_token %}
                            <button type="submit">Del</button>
                        </form>
                    {% endif %}

                    <!-- replies list -->
                    {% for reply in comment.replies.all %}

                        <div class="reply-area">
                            <strong>↳
                            <img src="{{ reply.author.profile_image.url }}"
                            alt="profile"
                            class="comment-profile">

                                {{ reply.author.nick_name }}</strong>
                            <small>님의 댓글</small> :
                            <span>
                                {% if is_a_post %}
                                    {{ reply.content|truncatechars:20 }}
                                {% else %}
                                    {{ reply.content }}
                                {% endif %}
                            </span>
                            <small>{{ reply.display_time }}</small>

                            <!-- reply_delete -->
                            {% if comment_form and user == reply.author %}
                                <form method="POST"
                                    action="{% url 'moong:comment_delete' comment_id=reply.id %}"
                                    style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit">Del</button>
                                </form>
                            {% endif %}

                        </div>
                    {% endfor %}



                    <!-- replies add -->

                    {% if comment_form and not is_a_post %}
                    <div class="reply-form"
                        id="reply-form-{{ comment.id }}"
                        style="display:none; margin-left:20px; margin-top:8px;">
                        <form method="POST"
                            action="{% url 'moong:comment_add' post_id=post.id %}">
                            {% csrf_token %}
                            {{ comment_form.content }}
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <button type="submit">대댓글 등록</button>
                        </form>
                    </div>
                    {% endif %}

                </li>
                {% endif %}
            {% empty %}
                <li>댓글이 없습니다.</li>
            {% endfor %}
        </ul>
</div>

<!-- comment add -->

{% if comment_form %}
<div style="margin-top:16px;">
    <form method="POST" action="{% url 'moong:comment_add' post_id=post.id %}">
        {% csrf_token %}
        {{ comment_form.content }}
        <button type="submit">댓글 등록</button>
    </form>
</div>
{% endif %}

<!-- JS: 대댓글 폼 토글 -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".reply-toggle").forEach(function (btn) {
        btn.addEventListener("click", function () {
            const commentId = this.dataset.commentId;
            const form = document.getElementById("reply-form-" + commentId);

            if (!form) return;

            form.style.display =
                (form.style.display === "none" || form.style.display === "")
                ? "block"
                : "none";
        });
    });
});
</script>
