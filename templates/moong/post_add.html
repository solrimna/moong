{% extends 'base.html' %}
{% load static %}

{% block myHead %}
    {% if temp_post and temp_post.location %}
        <div id="saved_location"
            data-sido="{{ temp_post.location.sido }}"
            data-sigungu="{{ temp_post.location.sigungu }}"
            data-eupmyeondong="{{ temp_post.location.eupmyeondong }}"
            data-location-id="{{ temp_post.location.id }}">
        </div>
    {% elif is_edit and post.location %}
        <div id="saved_location"
            data-sido="{{ post.location.sido }}"
            data-sigungu="{{ post.location.sigungu }}"
            data-eupmyeondong="{{ post.location.eupmyeondong }}"
            data-location-id="{{ post.location.id }}">
        </div>        
    {% endif %}
    <script src="{% static 'js/img_view.js' %}"></script>
    <script src="{% static 'js/location_select.js' %}"></script>
{% endblock %}

{% block myBlock %}
    {% include 'moong/navigation.html' %}

    <div class="post-form-container">
        <div class="post-form-header">
        {% if is_edit %}
            <h2>게시글 수정</h2>
        {% else %}
            <h2>새 모임 만들기</h2>
        {% endif %}
        </div>
        <!-- 메시지 표시 -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <form method="POST" enctype="multipart/form-data" class="post-form-body">
            {% csrf_token %}
            {% if temp_post %}
                <input type="hidden" name="temp_post_id" value="{{ temp_post.id }}">
            {% endif %}
            <label>제목</label>
            {{ form.title }}
            {% if form.title.errors %}
                <span class="error-text">{{ form.title.errors }}</span>
            {% endif %}

            <label>내용</label>
            {{ form.content }}
            {% if form.content.errors %}
                <span class="error-text">{{ form.content.errors }}</span>
            {% endif %}

            <label>모임 날짜</label>
            {{ form.moim_date }}
            {% if form.moim_date.errors %}
                <span class="error-text">{{ form.moim_date.errors }}</span>
            {% endif %}

            <label>시간</label>
            {{ form.moim_time }}
            {% if form.moim_time.errors %}
                <span class="error-text">{{ form.moim_time.errors }}</span>
            {% endif %}

            <label>최대 인원</label>
            {{ form.max_people }}

            <label>장소</label>
            <div class="location-selects">
                <select id="sido">
                    <option value="">시/도 선택</option>
                </select>
                <select id="sigungu">
                    <option value="">시/군/구 선택</option>
                </select>
                <select id="eupmyeondong" name="location">
                    <option value="">읍/면/동 선택</option>
                </select>
            </div>
            {% if form.location.errors %}
                <span class="error-text">{{ form.location.errors }}</span>
            {% endif %}

            {% if existing_images %}
                <label>기존 이미지</label>
                <div class="existing-images-wrap">
                    {% for image in existing_images %}
                        <div class="existing-image">
                            <img src="{{ image.image.url }}" alt="이미지 {{ image.order }}">
                            <label class="delete-checkbox">
                                <input type="checkbox" name="delete_images" value="{{ image.id }}">
                                삭제
                            </label>
                        </div>
                    {% endfor %}
                </div>
                <label for="images">새 이미지 추가</label>
            {% else %}
                <label for="images">이미지 (여러 개 선택 가능)</label>
            {% endif %}
            <input type="file" name="images" id="images" multiple accept="image/*" style="display: none;">
            <div id="imagePreview" class="imagePreview"></div>

            <!-- AI 추천 해시태그 영역 -->
            {% if tags %}
            <div id="tags-section">
                {% include 'moong/tags_add.html' %}
            </div>
            {% endif %}

        <!-- 버튼 -->
        <div class="post-form-buttons">
            {% if is_edit %}
                <button type="submit">수정 완료</button>
                <a href="{% url 'moong:post_detail' post.id %}">취소</a>
            {% elif temp_post %}
                <!-- 임시저장 후: 게시 버튼만 -->
                <button type="submit">게시하기</button>
            {% else %}
                <!-- 처음: 둘 다 보임 -->
                <button type="submit">게시</button>
                <button type="submit" name="save_temp">임시저장</button>
            {% endif %}
        </div>
    </form>
    <script src="{% static 'js/hashtags_add.js' %}"></script>
<script>
// 메시지 자동 사라짐 기능
document.addEventListener("DOMContentLoaded", function() {
    const messages = document.querySelectorAll('.message');
    messages.forEach(message => {
        setTimeout(() => { message.style.opacity = '0'; setTimeout(() => message.remove(), 500); }, 3000);
    });
});
</script>
{% endblock %}