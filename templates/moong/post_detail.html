{% extends 'base.html' %}
{% load static %}

{% block myHead %}
<script src="{% static 'js/img_view.js' %}"></script>
<script>
    const DDOMOONG_URL_BASE = "{% url 'moong:give_ddomoong' participation_id=0 %}";
    const CSRF_TOKEN = "{{ csrf_token }}";
</script>
<script src="{% static 'js/ddo_moong.js' %}"></script>
{% endblock %}

{% block myBlock %}
    {% include 'moong/navigation.html' %}

    <div class="post-container">
        <div class="post-detail-card">
            <!-- 상태 배너 -->
            {% if post.is_closed and not post.moim_finished %}
                <div class="status-banner confirmed">
                    <h2>모집이 확정되었습니다</h2>
                    <p>확정 인원: <strong>{{ post.get_approved_count }}명</strong>{% if post.max_people %} / {{ post.max_people }}명{% endif %}</p>
                    <p style="font-size: 14px; opacity: 0.9; margin-top: 8px;">{{ post.moim_date }} {{ post.moim_time }}에 진행 예정</p>
                </div>
            {% elif post.moim_finished %}
                <div class="status-banner finished">
                    <h2>완료된 모임</h2>
                    <p>이 모임은 성공적으로 완료되었습니다</p>
                </div>
            {% elif post.is_cancelled %}
                <div class="status-banner cancelled">
                    <h2>이 모임은 취소되었습니다</h2>
                    <p>주최자에 의해 취소된 모임입니다</p>
                </div>
            {% else %}
                <div class="status-banner recruiting">
                    <h2>모집 중입니다</h2>
                    <p>현재 인원: <strong>{{ post.get_approved_count }}명</strong>{% if post.max_people %} / {{ post.max_people }}명{% endif %}</p>
                </div>
            {% endif %}

            <!-- 게시글 헤더 -->
            <div class="post-detail-header">
                <h1 class="post-detail-title">{{ post.title }}</h1>
                <div class="post-detail-author">
                    {% if user == post.author %}
                        <a href="{% url 'users:mypage' %}">
                            <img src="{{ post.author.profile_image.url }}" alt="프로필">
                        </a>
                    {% else %}
                        <a href="{% url 'users:user_profile' post.author.id %}">
                            <img src="{{ post.author.profile_image.url }}" alt="프로필">
                        </a>
                    {% endif %}
                    <div class="post-detail-author-info">
                        {% if user == post.author %}
                            <a href="{% url 'users:mypage' %}" class="post-detail-author-name">{{ post.author.nick_name }}</a>
                        {% else %}
                            <a href="{% url 'users:user_profile' post.author.id %}" class="post-detail-author-name">{{ post.author.nick_name }}</a>
                        {% endif %}
                        <div class="post-detail-date">{{ post.create_time }}</div>
                    </div>
                </div>
            </div>

            <!-- 모임 정보 -->
            <div class="post-detail-info">
                <div class="post-info-item">
                    <strong>모임 날짜</strong>
                    <span>{{ post.moim_date }} {{ post.moim_time }}</span>
                </div>
                <div class="post-info-item">
                    <strong>모임 장소</strong>
                    <span>
                        {% if post.location %}
                            {{ post.location.sido }} {{ post.location.sigungu }} {{ post.location.eupmyeondong }}
                        {% else %}
                            장소 미정
                        {% endif %}
                    </span>
                </div>
                {% if post.max_people %}
                <div class="post-info-item">
                    <strong>최대 인원</strong>
                    <span>{{ post.max_people }}명</span>
                </div>
                {% endif %}
            </div>

            <!-- 본문 -->
            <div class="post-detail-content">
                <p>{{ post.content }}</p>

                {% if post.images.all %}
                <div class="post-detail-images">
                    {% for image in post.images.all %}
                        <img src="{{ image.image.url }}" alt="{{ post.title }}">
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div>
                {% if request.user.is_authenticated %}
    
                    {% if request.user == post.author %}
                        <p>당신은 이 모임의 주최자입니다. 하단의 명단에서 신청자를 관리하세요.</p>

                    {% else %}          
                        {% if not user_participation %}
                            <form action="{% url 'moong:participation_apply' post.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">참여 신청</button>
                            </form>

                        {% elif user_participation.status == 'PENDING' %}
                            <form action="{% url 'moong:participation_cancel' post.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">{% if post.is_full %}정원 초과{% else %}참여 신청 중{% endif %}</button>
                            </form>
                        {% elif user_participation.status == 'APPROVED' %}
                            <form action="{% url 'moong:participation_cancel' post.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">참여 취소</button>
                            </form>
        
                        {% elif user_participation.status == 'REJECTED' %}
                            <form action="{% url 'moong:participation_apply' post.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">{% if post.is_full %}정원 초과{% else %}참여 신청 (재신청){% endif %}</button>
                            </form>
                        {% endif %}
                    {% endif %}

                {% else %}
                    <p><a href="{% url 'users:login' %}">로그인</a> 후 신청할 수 있습니다.</p>
                {% endif %}
                
            </div>
            
            <div class="info-box">
                <span>참여 현황: <strong>{{ post.get_approved_count }}</strong> / {{ post.max_people }}명</span>
                {% if post.is_full %}
                    <span style="color: red; font-weight: bold;">[마감]</span>
                    <span>대기자 수: <strong>{{ post.get_wait_count }}</strong></span>
                {% endif %}
            </div>

            <div>
                <ul>
                    {% for participant,approval,index in approved_participants_and_approval %}
                        <li>                               
                            <a href="{% url 'users:user_profile' participant.user.id %}"> {{ participant.user.nick_name|default:participant.user.username }} </a>
                            {% if user == post.author %}
                                <form action="{% url 'moong:participation_manage' participant.id %}" method="post">
                                    {% csrf_token %}
                                    {% if participant.status == 'APPROVED' %}
                                        <button type="submit" name="action_complete" value="reject"> 승인취소 </button>
                                    {% elif participant.status == 'COMPLETED' %}
                                        <button type="submit" name="action_complete" disabled> 최종 완료 </button> 
                                    {% else %}
                                        <button type="submit" name="action_complete" value="approve"> 승인 </button>
                                    {% endif %}             
                                </form>
                            {% endif %}   
                            {% if participant.user == post.author %}
                                (주최자)
                            {% endif %}
                            
                            {% if participant.status == 'APPROVED' %}
                                {% if not approval %}
                                    <small>- {{ participant.create_time|date:"Y-m-d H:i" }} 참여 완료</small>
                                {% else %}
                                    <small>- {{ participant.create_time|date:"Y-m-d H:i" }} 대기자 {{ index }}</small>
                                {% endif %}
                            {% endif %}
                            {% if participant.status == 'PENDING' %}
                                <small>- {{ participant.create_time|date:"Y-m-d H:i" }} 참여 신청 중</small>
                            {% endif %}

                            </li>
                        {% empty %}
                            <li style="color: var(--moong-text-light);">참여자가 없습니다.</li>
                        {% endfor %}
                    </ul>
                </details>
                {% if post.moim_finished %}
                    {% include "moong/ddo_moong.html" with participants=ddomoong_participants %}
                {% endif %}
            </div>
        </div>
        
        <div class="post-tags">
            {% for tag in post.hashtags.all %}
                <a href="{% url 'moong:tag_feeds' tag.name %}">#{{ tag.name }}</a>
            {% endfor %}
        </div>

            <!-- 댓글 -->
            <div style="padding: 24px; border-top: 2px solid var(--moong-bg-light);">
                {% include "moong/comments.html" with is_a_post=False %}
            </div>

        <!-- 메시지 표시 -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
                {% if 'alert_popup' in message.tags %}
                    <script>alert("{{ message }}");</script>
                {% else %}
                    <div class="message {{ message.tags }}">
                        {{ message }}
                    </div>
                {% endif %} 
            {% endfor %}
        </div>
        {% endif %}
        <div class="button-group">
            <a href="{% url 'moong:main' %}" class="btn btn-secondary">목록으로</a>
            {% if user == post.author %}
                <a href="{% url 'moong:post_mod' post.id %}" class="btn btn-primary"> 모임글 수정</a>
                <form method="POST" action="{% url 'moong:post_closed' post.id %}" >
                    {% csrf_token %}
                    <button type="submit">
                        {% if post.is_closed %}모집 확정 취소{% else %}모집 확정{% endif %}
                    </button>
                </form>
                {% if post.is_closed %}
                    <form method="POST" action="{% url 'moong:moim_finished' post.id %}" >
                        {% csrf_token %}
                        <button type="submit">
                            모임 완료
                        </button>
                    </form>
                {% endif %}
                <form method="POST" action="{% url 'moong:post_delete' post.id %}" >
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('모집글을 삭제하시겠습니까?\r\n확정 참여자가 없는 경우에만 삭제가 가능합니다');">
                        모임 삭제 
                    </button>
                </form>
            {% endif %}
            </div>
        </div>
    </div>

    <!-- 이미지 모달 -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>
{% endblock %}