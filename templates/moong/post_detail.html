{% extends 'base.html' %}
{% load static %}

{% block myHead %}  
<script src="{% static 'js/img_view.js' %}"></script>
{% endblock %}

{% block myBlock %}
    {% include 'moong/navigation.html' %}
    <div class="post-container">
        <!-- ë°°ë„ˆ -->
        {% if post.is_closed %}
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; text-align: center;">
            <h2 style="margin: 0; font-size: 24px;">ğŸ”’ ëª¨ì§‘ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤</h2>
            <p style="margin: 10px 0 0 0;">
                í™•ì • ì¸ì›: <strong>{{ post.get_approved_count }}ëª…</strong>
                {% if post.max_people %}
                / {{ post.max_people }}ëª…
                {% endif %}
            </p>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">
                ğŸ“… {{ post.moim_date }} {{ post.moim_time }}ì— ì§„í–‰ ì˜ˆì •ì…ë‹ˆë‹¤
            </p>
        </div>
        {% elif post.moim_finished %}
            <span style="color: #28a745;">âœ… ì™„ë£Œëœ ëª¨ì„</span>
        {% elif post.is_cancelled %}
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; text-align: center;">
            <h2 style="margin: 0; font-size: 24px;">ğŸ’¥ ì´ ëª¨ì„ì€ í­íŒŒë˜ì—ˆìŠµë‹ˆë‹¤</h2>
            <p style="margin: 10px 0 0 0;">ì£¼ìµœìì— ì˜í•´ ì·¨ì†Œëœ ëª¨ì„ì…ë‹ˆë‹¤.</p>
        </div>
        {% else %}
        <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; padding: 20px; margin-bottom: 20px; border-radius: 10px; text-align: center;">
            <h2 style="margin: 0; font-size: 24px;">ğŸŸ¢ ëª¨ì§‘ ì¤‘ì…ë‹ˆë‹¤</h2>
            <p style="margin: 10px 0 0 0;">
                í˜„ì¬ ì¸ì›: <strong>{{ post.get_approved_count }}ëª…</strong>
                {% if post.max_people %}
                / {{ post.max_people }}ëª…
                {% endif %}
            </p>
        </div>
        {% endif %}

        <div class="post-header">
            <h4 style="margin: 5px 0;">
            <a href="{% url 'moong:post_detail' post.id %}">
                {{ post.title }}
            </a> 
            </h4>
            <div class="post-profile-image-wrapper">
                {% if user == post.author %}
                    <a href="{% url 'users:mypage' %}">
                        <img src="{{ post.author.profile_image.url }}" alt="í”„ë¡œí•„" class ='profile-image'>
                        ì‘ì„±ì: {{ post.author.nick_name }} 
                    </a>
                {% else %}
                    <a href="{% url 'users:user_profile' post.author.id %}">
                        <img src="{{ post.author.profile_image.url }}" alt="í”„ë¡œí•„" class ='profile-image'>
                        ì‘ì„±ì: {{ post.author.nick_name }}
                    </a>
                {% endif %}
                | {{ post.create_time }}
            </div>
        </div>
        <div class="post-info">
            <div>
                <strong>ğŸ“… ëª¨ì„ ë‚ ì§œ:</strong> 
                {{ post.moim_date }} {{ post.moim_time }}
            </div>
            <div>
                <strong>ğŸ“ ëª¨ì„ ì¥ì†Œ:</strong>
                {% if post.location %}
                    {{ post.location.sido }} {{ post.location.sigungu }} {{ post.location.eupmyeondong }}
                {% else %}
                    ì¥ì†Œ ë¯¸ì •
                {% endif %}
            </div>
            {% if post.max_people %}
                <div>
                    <strong>ğŸ‘¥ ìµœëŒ€ ì¸ì›:</strong> 
                    {{ post.max_people }}ëª…
                </div>
            {% endif %}
            <div class="post-content">
                {{ post.content }}
            </div>
            <div class="post-images">
                {% for image in post.images.all %}
                    <img src="{{ image.image.url }}" alt="{{ post.title }}" style="max-width: 100%; margin: 10px 0;">
                {% endfor %}
            </div>


            <div>
                {% if request.user.is_authenticated %}
    
                    {% if request.user == post.author %}
                        <p>ë‹¹ì‹ ì€ ì´ ëª¨ì„ì˜ ì£¼ìµœìì…ë‹ˆë‹¤. í•˜ë‹¨ì˜ ëª…ë‹¨ì—ì„œ ì‹ ì²­ìë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</p>

                    {% else %}          
                        {% if not user_participation %}
                            <form action="{% url 'moong:post_apply' post.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">ì°¸ì—¬ ì‹ ì²­</button>
                            </form>

                        {% elif user_participation.status == 'PENDING' %}
                            <form action="{% url 'moong:post_cancel' post.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">{% if post.is_full %}ì •ì› ì´ˆê³¼{% else %}ì°¸ì—¬ ì‹ ì²­ ì¤‘{% endif %}</button>
                            </form>
                        {% elif user_participation.status == 'APPROVED' %}
                            <form action="{% url 'moong:post_cancel' post.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">ì°¸ì—¬ ì·¨ì†Œ</button>
                            </form>
        
                        {% elif user_participation.status == 'REJECTED' %}
                            <form action="{% url 'moong:post_apply' post.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">{% if post.is_full %}ì •ì› ì´ˆê³¼{% else %}ì°¸ì—¬ ì‹ ì²­ (ì¬ì‹ ì²­){% endif %}</button>
                            </form>
                        {% endif %}
                    {% endif %}

                {% else %}
                    <p><a href="{% url 'users:login' %}">ë¡œê·¸ì¸</a> í›„ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                {% endif %}
                
            </div>

            <div class="info-box">
                <span>ì°¸ì—¬ í˜„í™©: <strong>{{ post.get_approved_count }}</strong> / {{ post.max_people }}ëª…</span>
                {% if post.is_full %}
                    <span style="color: red; font-weight: bold;">[ë§ˆê°]</span>
                {% endif %}
            </div>

            <div>
                <details>
                    <summary>
                        ì°¸ì—¬ì ëª©ë¡ ë³´ê¸° (í˜„ì¬ {{ approved_participants.count }}ëª…)
                    </summary>
        
                    <ul>
                        {% for participant in approved_participants %}
                            <li>
                                {{ participant.user.nick_name|default:participant.user.username }}
                                {% if user == post.author %}
                                    <form action="{% url 'moong:participant_manage' participant.id %}" method="post">
                                        {% csrf_token %}
                                        {% if participant.status == 'APPROVED' %}
                                            <button type="submit" name="action_complete" value="reject"> ìŠ¹ì¸ì·¨ì†Œ </button> 
                                        {% else %}
                                            <button type="submit" name="action_complete" value="approve"> ìŠ¹ì¸ </button>
                                        {% endif %}                 
                                    </form>
                                {% endif %}   
                                {% if participant.user == post.author %}
                                    (ì£¼ìµœì)
                                {% else %}
                                    {% comment %} ì£¼ìµœìê°€ ì•„ë‹ ë•Œ {% endcomment %}
                                {% endif %}
                                
                                {% if participant.status == 'APPROVED' %}
                                    <small>- {{ participant.create_time|date:"Y-m-d H:i" }} ì°¸ì—¬ ì™„ë£Œ</small>
                                {% endif %}
                                {% if participant.status == 'PENDING' %}
                                    <small>- {{ participant.create_time|date:"Y-m-d H:i" }} ì°¸ì—¬ ì‹ ì²­ ì¤‘</small>
                                {% endif %}

                                {% comment %} ì²´í¬ ë°•ìŠ¤ ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ì„œ ì²´í¬ë¥¼ í•´ì•¼í•¨  {% endcomment %}
                            </li>
                        {% empty %}
                            <li>ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                        {% endfor %}
                    </ul>
                </details>
            </div>
        </div>
        
        <div class="post-tags" style="margin-top: 10px;">
            {% for tag in post.hashtags.all %}
                <a href="{% url 'moong:tag_feeds' tag.name %}" style="text-decoration: none; color: #007bff; font-size: 0.9rem;">#{{ tag.name }}</a>
            {% endfor %}
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">


        <!--ëŒ“ê¸€-->
        {% include "moong/comments.html" with is_a_post=False %}

        <!-- ë©”ì‹œì§€ í‘œì‹œ -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="button-group">
            <a href="{% url 'moong:main' %}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
            {% if user == post.author %}
                <a href="{% url 'moong:post_mod' post.id %}" class="btn btn-primary"> ëª¨ì„ê¸€ ìˆ˜ì •</a>
                {% if not post.is_closed %}
                    <form method="POST" action="{% url 'moong:post_closed' post.id %}" >
                        {% csrf_token %}
                        <button type="submit">
                            ëª¨ì§‘ í™•ì •
                        </button>
                    </form>
                {% else %}
                    <form method="POST" action="{% url 'moong:post_closed_cancel' post.id %}" >
                        {% csrf_token %}
                        <button type="submit">
                            ëª¨ì§‘ í™•ì • ì·¨ì†Œ
                        </button>
                    </form>

                    <form method="POST" action="{% url 'moong:moim_finished' post.id %}" >
                        {% csrf_token %}
                        <button type="submit">
                            ëª¨ì„ ì™„ë£Œ
                        </button>
                    </form>
                {% endif %}
                <form method="POST" action="{% url 'moong:post_delete' post.id %}" >
                    {% csrf_token %}
                    {% comment %} ì°¸ì—¬ì í™•ì • ì²˜ë¦¬ ê°œë°œ ì´í›„ ì¶”ê°€ ìˆ˜ì • í•„ìš”  {% endcomment %}
                    <button type="submit" onclick="return confirm('ëª¨ì§‘ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\r\ní™•ì • ì°¸ì—¬ìê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤');">
                        ëª¨ì„ ì‚­ì œ 
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImage">
</div>    
{% endblock %}