<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 수정 - MOONG!</title>
    <style>
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .image-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        .existing-image {
            display: inline-block;
            margin: 10px;
            position: relative;
        }
        .existing-image img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        .delete-checkbox {
            position: absolute;
            top: 5px;
            right: 5px;
            background: white;
            padding: 2px;
        }
    </style>
</head>

<body>
    {% include 'moong/navigation.html' %}

    <h1>게시글 수정</h1>

    <!-- 메시지 표시 -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 폼 전체 에러 -->
    {% if form.non_field_errors %}
    <div class="form-errors">
        {{ form.non_field_errors }}
    </div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <p>
            <label>제목</label><br>
            {{ form.title }}
            {% if form.title.errors %}
                <span style="color: red;">{{ form.title.errors }}</span>
            {% endif %}
            <br>

            <label>내용</label><br>
            {{ form.content }}
            {% if form.content.errors %}
                <span style="color: red;">{{ form.content.errors }}</span>
            {% endif %}
            <br>

            <label>모임 날짜</label><br>
            {{ form.moim_date }}
            {% if form.moim_date.errors %}
                <span style="color: red;">{{ form.moim_date.errors }}</span>
            {% endif %}
            <br>

            <label>시간</label><br>
            {{ form.moim_time }}
            {% if form.moim_time.errors %}
                <span style="color: red;">{{ form.moim_time.errors }}</span>
            {% endif %}
            <br>

            <label>최대 인원</label><br>
            {{ form.max_people }}
            <br>

            <!-- 장소 (3단계 선택) -->
            <label>장소</label><br>
            <label for="sido">시/도</label>
            <select id="sido">
                <option value="">시/도 선택</option>
            </select>

            <label for="sigungu">시/군/구</label>
            <select id="sigungu">
                <option value="">시/군/구 선택</option>
            </select>

            <label for="eupmyeondong">읍/면/동</label>
            <select id="eupmyeondong" name="location">
                <option value="">읍/면/동 선택</option>
            </select>
            {% if form.location.errors %}
                <span style="color: red;">{{ form.location.errors }}</span>
            {% endif %}
            <br>

            <!-- 기존 이미지 -->
            {% if existing_images %}
            <fieldset>
                <legend>기존 이미지</legend>
                {% for image in existing_images %}
                <div class="existing-image">
                    <img src="{{ image.image.url }}" alt="이미지 {{ image.order }}">
                    <label class="delete-checkbox">
                        <input type="checkbox" name="delete_images" value="{{ image.id }}">
                        삭제
                    </label>
                </div>
                {% endfor %}
            </fieldset>
            <br>
            {% endif %}

            <!-- 새 이미지 추가 -->
            <label>새 이미지 추가 (Ctrl+클릭으로 여러 개 선택)</label><br>
            <input type="file" name="images" id="images" multiple accept="image/*">
            <div id="image-preview" class="image-preview"></div>
            <br>
        </p>

        <hr>
        <div id="tags-section">
            {% include 'moong/tags_add.html' %}
        </div>
        <hr>

        <button type="submit">수정 완료</button>
        <button type="submit" name="save_temp">임시저장</button>
        <a href="{% url 'moong:post_detail' post.id %}">취소</a>
    </form>
    
<!-- ===================== -->
<!-- AJAX 행정구역 JS -->
<!-- ===================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const sidoSelect = document.getElementById("sido");
    const sigunguSelect = document.getElementById("sigungu");
    const eupSelect = document.getElementById("eupmyeondong");

    // 기존 location 값 설정
    {% if post.location %}
    const existingLocationId = {{ post.location.id }};
    const existingSido = "{{ post.location.sido }}";
    const existingSigungu = "{{ post.location.sigungu }}";
    const existingEup = "{{ post.location.eupmyeondong }}";
    {% else %}
    const existingLocationId = null;
    {% endif %}

    // 1️⃣ 시/도 로드
    fetch("/locations/sido/")
        .then(res => res.json())
        .then(data => {
            data.forEach(sido => {
                const opt = document.createElement("option");
                opt.value = sido;
                opt.textContent = sido;
                sidoSelect.appendChild(opt);
            });
            
            // 기존 값 설정
            {% if post.location %}
            sidoSelect.value = existingSido;
            loadSigungu(existingSido);
            {% endif %}
        })
        .catch(err => console.error("시/도 로드 실패", err));

    // 시/군/구 로드 함수
    function loadSigungu(sido) {
        fetch(`/locations/sigungu/?sido=${encodeURIComponent(sido)}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(sigungu => {
                    const opt = document.createElement("option");
                    opt.value = sigungu;
                    opt.textContent = sigungu;
                    sigunguSelect.appendChild(opt);
                });
                
                // 기존 값 설정
                {% if post.location %}
                sigunguSelect.value = existingSigungu;
                loadEup(existingSido, existingSigungu);
                {% endif %}
            })
            .catch(err => console.error("시/군/구 로드 실패", err));
    }

    // 읍/면/동 로드 함수
    function loadEup(sido, sigungu) {
        fetch(`/locations/eupmyeondong/?sido=${encodeURIComponent(sido)}&sigungu=${encodeURIComponent(sigungu)}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(obj => {
                    const opt = document.createElement("option");
                    opt.value = obj.id;
                    opt.textContent = obj.name;
                    eupSelect.appendChild(opt);
                });
                
                // 기존 값 설정
                {% if post.location %}
                eupSelect.value = existingLocationId;
                {% endif %}
            })
            .catch(err => console.error("읍/면/동 로드 실패", err));
    }

    // 2️⃣ 시/도 변경 이벤트
    sidoSelect.addEventListener("change", function () {
        const sido = this.value;
        sigunguSelect.innerHTML = `<option value="">시/군/구 선택</option>`;
        eupSelect.innerHTML = `<option value="">읍/면/동 선택</option>`;
        if (!sido) return;
        loadSigungu(sido);
    });

    // 3️⃣ 시/군/구 변경 이벤트
    sigunguSelect.addEventListener("change", function () {
        const sigungu = this.value;
        const sido = sidoSelect.value;
        eupSelect.innerHTML = `<option value="">읍/면/동 선택</option>`;
        if (!sido || !sigungu) return;
        loadEup(sido, sigungu);
    });
});
</script>

<!-- ===================== -->
<!-- 이미지 미리보기 JS -->
<!-- ===================== -->
<script>
document.getElementById('images').addEventListener('change', function(e) {
    console.log("선택된 파일 개수:", e.target.files.length);
    
    const preview = document.getElementById('image-preview');
    preview.innerHTML = '';
    
    const files = e.target.files;
    
    for (let i = 0; i < files.length; i++) {
        console.log(`파일 ${i}:`, files[i].name);
    }
    
    if (files.length > 5) {
        alert('이미지는 최대 5개까지 업로드 가능합니다.');
        e.target.value = '';
        return;
    }
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        if (!file.type.startsWith('image/')) {
            continue;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
});
</script>

</body>
</html>