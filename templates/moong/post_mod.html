{% extends 'base.html' %}
{% load static %}

{% block myHead %}
    {% if post and post.location %}
        <div id="saved_location"
            data-sido="{{ post.location.sido }}"
            data-sigungu="{{ post.location.sigungu }}"
            data-eupmyeondong="{{ post.location.eupmyeondong }}"
            data-location-id="{{ post.location.id }}">
        </div>
    {% endif %}
    <script src="{% static 'js/img_view.js' %}"></script>
    <script src="{% static 'js/location_select.js' %}"></script>
{% endblock %}

{% block myBlock %}
    {% include 'moong/navigation.html' %}

    <h1>게시글 수정</h1>

    <!-- 메시지 표시 -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message {{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 폼 전체 에러 -->
    {% if form.non_field_errors %}
    <div class="form-errors">
        {{ form.non_field_errors }}
    </div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <p>
            <label>제목</label><br>
            {{ form.title }}
            {% if form.title.errors %}
                <span style="color: red;">{{ form.title.errors }}</span>
            {% endif %}
            <br>

            <label>내용</label><br>
            {{ form.content }}
            {% if form.content.errors %}
                <span style="color: red;">{{ form.content.errors }}</span>
            {% endif %}
            <br>

            <label>모임 날짜</label><br>
            {{ form.moim_date }}
            {% if form.moim_date.errors %}
                <span style="color: red;">{{ form.moim_date.errors }}</span>
            {% endif %}
            <br>

            <label>시간</label><br>
            {{ form.moim_time }}
            {% if form.moim_time.errors %}
                <span style="color: red;">{{ form.moim_time.errors }}</span>
            {% endif %}
            <br>

            <label>최대 인원</label><br>
            {{ form.max_people }}
            <br>

            <!-- 장소 (3단계 선택) -->
            <label>장소</label><br>
            <label for="sido">시/도</label>
            <select id="sido">
                <option value="">시/도 선택</option>
            </select>

            <label for="sigungu">시/군/구</label>
            <select id="sigungu">
                <option value="">시/군/구 선택</option>
            </select>

            <label for="eupmyeondong">읍/면/동</label>
            <select id="eupmyeondong" name="location">
                <option value="">읍/면/동 선택</option>
            </select>
            {% if form.location.errors %}
                <span style="color: red;">{{ form.location.errors }}</span>
            {% endif %}
            <br>

            <!-- 기존 이미지 -->
            {% if existing_images %}
            <fieldset>
                <legend>기존 이미지</legend>
                {% for image in existing_images %}
                <div class="existing-image">
                    <img src="{{ image.image.url }}" alt="이미지 {{ image.order }}">
                    <label class="delete-checkbox">
                        <input type="checkbox" name="delete_images" value="{{ image.id }}">
                        삭제
                    </label>
                </div>
                {% endfor %}
            </fieldset>
            <br>
            {% endif %}

            <!-- 새 이미지 추가 -->
            <label>새 이미지 추가 (Ctrl+클릭으로 여러 개 선택)</label><br>
            <input type="file" name="images" id="images" multiple accept="image/*">
            <div id="imagePreview" class="imagePreview"></div>
            <br>
        </p>

        <hr>
        <div id="tags-section">
            {% include 'moong/tags_add.html' %}
        </div>
        <hr>

        <button type="submit">수정 완료</button>
        <a href="{% url 'moong:post_detail' post.id %}">취소</a>
    </form>
{% endblock %}