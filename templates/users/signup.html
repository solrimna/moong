{% load static %}

<div id="signup">
  <form method="POST" enctype="multipart/form-data">
    <h1>Moong!</h1>

    {% csrf_token %}

      <h3>E-MAIL 주소</h3>
      {{ form.email }}

        {% if form.email.errors %}
            <ul class="field-error">
                {% for error in form.email.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div> 
    
    
    <!-- <div>
      <h3>사용자 ID</h3>
      {{ form.username }}

        {% if form.username.errors %}
            <ul class="field-error">
                {% for error in form.username.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div> -->


    <div>
      <h3>패스워드 입력</h3>
      {{ form.password1 }}

        {% if form.password1.errors %}
            <ul class="field-error">
                {% for error in form.password1.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}      
    </div>

    <div>
      <h3>패스워드 확인</h3>
      {{ form.password2 }}

        {% if form.password2.errors %}
            <ul class="field-error">
                {% for error in form.password2.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}      
    </div>

    
    <div>
      <h3>닉네임 설정</h3>
      {{ form.nick_name }}

        {% if form.nick_name.errors %}
            <ul class="field-error">
                {% for error in form.nick_name.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}      
    </div>
    
    
      <!-- <h3>휴대전화번호</h3>
      {{ form.phone }}

        {% if form.phone.errors %}
            <ul class="field-error">
                {% for error in form.phone.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>    -->

   
    
    <div>
      <h3>프로필 이미지</h3>
      {{ form.profile_image }}
    </div>

    <!-- 활동 지역 선택 (AJAX) -->
    <div>
      <h3>활동 지역 선택</h3>

      <label for="sido">시/도</label>
      <select id="sido">
        <option value="">시/도 선택</option>
      </select>

      <label for="sigungu">시/군/구</label>
      <select id="sigungu">
        <option value="">시/군/구 선택</option>
      </select>

      <label for="eupmyeondong">읍/면/동</label>
      <!-- ⭐ Django Form의 location 필드와 연결 -->
      <select id="eupmyeondong" name="location" required>
        <option value="">읍/면/동 선택</option>
      </select>
    </div>
    <br>
    <br>
    <button type="submit">뭉! 가입</button>
  </form>
</div>

<!-- ===================== -->
<!-- AJAX 행정구역 JS -->
<!-- ===================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const sidoSelect = document.getElementById("sido");
  const sigunguSelect = document.getElementById("sigungu");
  const eupSelect = document.getElementById("eupmyeondong");

  // 1️⃣ 시/도 로드
  fetch("/locations/sido/")
    .then(res => res.json())
    .then(data => {
      data.forEach(sido => {
        const opt = document.createElement("option");
        opt.value = sido;
        opt.textContent = sido;
        sidoSelect.appendChild(opt);
      });
    })
    .catch(err => {
      console.error("시/도 로드 실패", err);
    });

  // 2️⃣ 시/도 변경 → 시/군/구
  sidoSelect.addEventListener("change", function () {
    const sido = this.value;

    // 하위 초기화
    sigunguSelect.innerHTML = `<option value="">시/군/구 선택</option>`;
    eupSelect.innerHTML = `<option value="">읍/면/동 선택</option>`;

    if (!sido) return;

    fetch(`/locations/sigungu/?sido=${encodeURIComponent(sido)}`)
      .then(res => res.json())
      .then(data => {
        data.forEach(sigungu => {
          const opt = document.createElement("option");
          opt.value = sigungu;
          opt.textContent = sigungu;
          sigunguSelect.appendChild(opt);
        });
      })
      .catch(err => {
        console.error("시/군/구 로드 실패", err);
      });
  });

  // 3️⃣ 시/군/구 변경 → 읍/면/동
  sigunguSelect.addEventListener("change", function () {
    const sigungu = this.value;
    const sido = sidoSelect.value;

    eupSelect.innerHTML = `<option value="">읍/면/동 선택</option>`;

    if (!sido || !sigungu) return;

    fetch(
      `/locations/eupmyeondong/?sido=${encodeURIComponent(sido)}&sigungu=${encodeURIComponent(sigungu)}`
    )
      .then(res => res.json())
      .then(data => {
        data.forEach(obj => {
          const opt = document.createElement("option");
          opt.value = obj.id;       // ⭐ Location.id
          opt.textContent = obj.name;
          eupSelect.appendChild(opt);
        });
      })
      .catch(err => {
        console.error("읍/면/동 로드 실패", err);
      });
  });

});
</script>
